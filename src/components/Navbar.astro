---
// Build search index from all markdown files at build time
interface SearchEntry {
  title: string;
  route: string;
  headings: string[];
  excerpt: string;
}

const mods = import.meta.glob('/src/content/docs/**/*.md', { eager: true }) as Record<string, any>;

function fileToRoute(filePath: string): string {
  const rel = filePath.replace(/^\/src\/content\/docs/, '');
  let route = '/docs' + rel.replace(/\.md$/, '');
  route = route.replace(/\/index$/, '') || '/docs';
  return route.replace(/\/+/g, '/');
}

const searchIndex: SearchEntry[] = Object.entries(mods).map(([path, mod]) => {
  const title = mod.frontmatter?.title || path.split('/').pop()?.replace('.md', '') || '';
  const headings = (mod.getHeadings?.() || []).map((h: any) => h.text);
  // Extract raw body text for excerpt (strip markdown syntax)
  const rawContent = mod.rawContent?.() || mod.compiledContent?.() || '';
  const plainText = rawContent
    .replace(/<[^>]+>/g, '')
    .replace(/[#*_~`>\[\]()!|]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
  const excerpt = plainText.slice(0, 200);
  return {
    title,
    route: fileToRoute(path),
    headings,
    excerpt,
  };
});
---
<header class="sticky top-0 z-50 w-full border-b border-docs-border dark:border-docs-border-dark bg-white/80 dark:bg-docs-bg-dark/80 backdrop-blur-sm">
  <div class="max-w-7xl mx-auto flex items-center justify-between h-16 px-4 lg:px-8">
    <!-- Logo / Site Title -->
    <div class="flex items-center gap-3">
      <a href="/" class="flex items-center gap-2 text-lg font-semibold text-docs-text dark:text-docs-text-dark hover:text-docs-accent dark:hover:text-indigo-400 transition-colors">
        <svg class="w-8 h-8 text-docs-accent" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" rx="8" fill="currentColor"/>
          <path d="M9 12h14M9 16h10M9 20h14" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>Blog</span>
      </a>
    </div>

    <!-- Search Bar (center) -->
    <div class="flex-1 max-w-md mx-4 relative" id="search-container">
      <div class="relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-docs-text-muted dark:text-docs-text-muted-dark pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          id="search-input"
          type="text"
          placeholder="Search docs..."
          autocomplete="off"
          class="w-full pl-9 pr-12 py-2 text-sm rounded-lg border border-docs-border dark:border-docs-border-dark bg-slate-50 dark:bg-slate-800 text-docs-text dark:text-docs-text-dark placeholder-docs-text-muted dark:placeholder-docs-text-muted-dark focus:outline-none focus:ring-2 focus:ring-docs-accent focus:border-transparent transition-colors"
        />
        <kbd class="absolute right-3 top-1/2 -translate-y-1/2 hidden sm:inline-flex items-center px-1.5 py-0.5 text-[10px] font-mono font-medium text-docs-text-muted dark:text-docs-text-muted-dark bg-white dark:bg-slate-700 border border-docs-border dark:border-docs-border-dark rounded">
          Ctrl K
        </kbd>
      </div>
      <!-- Search Results Dropdown -->
      <div id="search-results" class="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-slate-800 border border-docs-border dark:border-docs-border-dark rounded-lg shadow-xl max-h-80 overflow-y-auto hidden z-50">
      </div>
    </div>

    <!-- Right Side Actions -->
    <div class="flex items-center gap-2">
      <!-- GitHub Link (optional) -->
      <a
        href="https://github.com"
        target="_blank"
        rel="noopener noreferrer"
        class="hidden sm:flex items-center justify-center w-10 h-10 rounded-lg text-docs-text-muted dark:text-docs-text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
        aria-label="GitHub"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
      </a>

      <!-- Dark Mode Toggle -->
      <button
        id="theme-toggle"
        class="flex items-center justify-center w-10 h-10 rounded-lg text-docs-text-muted dark:text-docs-text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
        aria-label="Toggle dark mode"
      >
        <!-- Sun icon (shown in dark mode) -->
        <svg class="w-5 h-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <!-- Moon icon (shown in light mode) -->
        <svg class="w-5 h-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>

      <!-- Mobile Menu Toggle -->
      <button
        id="mobile-menu-toggle"
        class="lg:hidden flex items-center justify-center w-10 h-10 rounded-lg text-docs-text-muted dark:text-docs-text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
        aria-label="Toggle menu"
      >
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- Mobile Sidebar Overlay -->
<div id="mobile-sidebar-overlay" class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm hidden lg:hidden">
  <div id="mobile-sidebar-panel" class="absolute left-0 top-0 bottom-0 w-80 max-w-[85vw] bg-white dark:bg-docs-bg-dark shadow-2xl transform -translate-x-full transition-transform duration-300">
    <div class="flex items-center justify-between h-16 px-4 border-b border-docs-border dark:border-docs-border-dark">
      <span class="font-semibold text-docs-text dark:text-docs-text-dark">Navigation</span>
      <button id="mobile-sidebar-close" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
        <svg class="w-5 h-5 text-docs-text-muted dark:text-docs-text-muted-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="mobile-sidebar-content" class="p-4 overflow-y-auto h-[calc(100vh-4rem)]"></div>
  </div>
</div>

<script>
  // Theme toggle functionality
  const themeToggle = document.getElementById('theme-toggle');

  // Initialize theme from localStorage or system preference
  function initTheme() {
    const stored = localStorage.getItem('theme');
    if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }

  initTheme();

  themeToggle?.addEventListener('click', () => {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });

  // Mobile menu functionality
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileOverlay = document.getElementById('mobile-sidebar-overlay');
  const mobilePanel = document.getElementById('mobile-sidebar-panel');
  const mobileClose = document.getElementById('mobile-sidebar-close');
  const mobileContent = document.getElementById('mobile-sidebar-content');

  function openMobileMenu() {
    // Copy sidebar content
    const sidebar = document.querySelector('aside nav');
    if (sidebar && mobileContent) {
      mobileContent.innerHTML = sidebar.innerHTML;
    }

    mobileOverlay?.classList.remove('hidden');
    requestAnimationFrame(() => {
      mobilePanel?.classList.remove('-translate-x-full');
    });
    document.body.style.overflow = 'hidden';
  }

  function closeMobileMenu() {
    mobilePanel?.classList.add('-translate-x-full');
    setTimeout(() => {
      mobileOverlay?.classList.add('hidden');
    }, 300);
    document.body.style.overflow = '';
  }

  mobileMenuToggle?.addEventListener('click', openMobileMenu);
  mobileClose?.addEventListener('click', closeMobileMenu);
  mobileOverlay?.addEventListener('click', (e) => {
    if (e.target === mobileOverlay) closeMobileMenu();
  });

  // Close on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !mobileOverlay?.classList.contains('hidden')) {
      closeMobileMenu();
    }
  });

  // ──── Client-side search ────
  const searchIndex = JSON.parse(document.getElementById('search-data')?.textContent || '[]');
  const searchInput = document.getElementById('search-input') as HTMLInputElement | null;
  const searchResults = document.getElementById('search-results');

  // Ctrl+K / Cmd+K to focus search
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      searchInput?.focus();
    }
    if (e.key === 'Escape' && document.activeElement === searchInput) {
      searchInput?.blur();
      hideResults();
    }
  });

  function hideResults() {
    searchResults?.classList.add('hidden');
  }

  function showResults() {
    searchResults?.classList.remove('hidden');
  }

  function performSearch(query: string) {
    if (!query.trim()) {
      hideResults();
      return;
    }

    const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
    type ScoredEntry = { title: string; route: string; headings: string[]; excerpt: string; score: number; matchedHeading?: string };

    const scored: ScoredEntry[] = searchIndex.map((entry: any) => {
      let score = 0;
      let matchedHeading = '';
      const titleLower = entry.title.toLowerCase();
      const excerptLower = entry.excerpt.toLowerCase();
      const headingsLower = entry.headings.map((h: string) => h.toLowerCase());

      for (const term of terms) {
        // Title match (highest weight)
        if (titleLower.includes(term)) score += 10;
        // Heading match
        for (const h of headingsLower) {
          if (h.includes(term)) {
            score += 5;
            if (!matchedHeading) matchedHeading = entry.headings[headingsLower.indexOf(h)];
          }
        }
        // Content match
        if (excerptLower.includes(term)) score += 2;
      }

      return { ...entry, score, matchedHeading };
    }).filter((e: ScoredEntry) => e.score > 0).sort((a: ScoredEntry, b: ScoredEntry) => b.score - a.score).slice(0, 8);

    if (scored.length === 0) {
      if (searchResults) {
        searchResults.innerHTML = `<div class="p-4 text-sm text-docs-text-muted dark:text-docs-text-muted-dark text-center">No results found</div>`;
      }
      showResults();
      return;
    }

    if (searchResults) {
      searchResults.innerHTML = scored.map((entry: ScoredEntry) => `
        <a href="${entry.route}" class="block px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-docs-border/50 dark:border-docs-border-dark/50 last:border-b-0">
          <div class="text-sm font-medium text-docs-text dark:text-docs-text-dark">${highlightMatch(entry.title, terms)}</div>
          ${entry.matchedHeading ? `<div class="text-xs text-docs-accent dark:text-indigo-400 mt-0.5"># ${highlightMatch(entry.matchedHeading, terms)}</div>` : ''}
          ${entry.excerpt ? `<div class="text-xs text-docs-text-muted dark:text-docs-text-muted-dark mt-1 line-clamp-1">${highlightMatch(entry.excerpt.slice(0, 100), terms)}</div>` : ''}
        </a>
      `).join('');
    }
    showResults();
  }

  function highlightMatch(text: string, terms: string[]): string {
    let result = escapeHtml(text);
    for (const term of terms) {
      const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
      result = result.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-800 text-inherit rounded px-0.5">$1</mark>');
    }
    return result;
  }

  function escapeHtml(str: string): string {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function escapeRegex(str: string): string {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Input event listener with debounce
  let debounceTimer: ReturnType<typeof setTimeout>;
  searchInput?.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      performSearch(searchInput.value);
    }, 150);
  });

  searchInput?.addEventListener('focus', () => {
    if (searchInput.value.trim()) {
      performSearch(searchInput.value);
    }
  });

  // Close results when clicking outside
  document.addEventListener('click', (e) => {
    const container = document.getElementById('search-container');
    if (container && !container.contains(e.target as Node)) {
      hideResults();
    }
  });
</script>

<!-- Search index data (hidden, consumed by JS) -->
<script type="application/json" id="search-data" set:html={JSON.stringify(searchIndex)}></script>
